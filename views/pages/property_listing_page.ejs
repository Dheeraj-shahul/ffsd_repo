<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/property_listing_page.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap");

      /* Override the problematic CSS rule */
      .form-group label::after {
        content: "" !important;
      }

      /* Error styling */
      .form-group.has-error input,
      .form-group.has-error select,
      .form-group.has-error textarea {
        border-color: #e74c3c !important;
      }

      .error-message {
        color: #e74c3c;
        font-size: 0.85rem;
        margin-top: 5px;
        display: none;
      }

      .form-group.has-error .error-message {
        display: block;
      }
    </style>
    <title>RENT EASE - List Your Property</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>

  <body>
    <%- include('../partials/header') %>

    <div class="page-container">
      <div class="page-header">
        <h1>List Your Property</h1>
        <p>Complete the form below to list your property on RentEase</p>
      </div>

      <div class="listing-form-container">
        <form id="property-listing-form" enctype="multipart/form-data">
          <div class="form-section">
            <h2>Basic Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="property-type">Property Type*</label>
                <select id="property-type" name="property-type" required>
                  <option value="">Select Property Type</option>
                  <option value="apartment">Apartment</option>
                  <option value="house">House</option>
                  <option value="villa">Villa</option>
                  <option value="pg">PG/Hostel</option>
                  <option value="commercial">Commercial Space</option>
                </select>
                <span class="error-message">Please select a property type</span>
              </div>
              <div class="form-group">
                <label for="property-subtype">Property Subtype*</label>
                <select id="property-subtype" name="property-subtype" required>
                  <option value="">Select Property Subtype</option>
                  <option value="1bhk">1 BHK</option>
                  <option value="2bhk">2 BHK</option>
                  <option value="3bhk">3 BHK</option>
                  <option value="4bhk">4 BHK</option>
                  <option value="duplex">Duplex</option>
                  <option value="box">Box Type</option>
                  <option value="studio">Studio</option>
                  <option value="other">Other</option>
                </select>
                <span class="error-message"
                  >Please select a property subtype</span
                >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bedrooms">Bedrooms*</label>
                <select id="bedrooms" name="bedrooms" required>
                  <option value="">Select</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5+">5+</option>
                </select>
                <span class="error-message"
                  >Please select number of bedrooms</span
                >
              </div>
              <div class="form-group">
                <label for="bathrooms">Bathrooms*</label>
                <select id="bathrooms" name="bathrooms" required>
                  <option value="">Select</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4+">4+</option>
                </select>
                <span class="error-message"
                  >Please select number of bathrooms</span
                >
              </div>
              <div class="form-group">
                <label for="furnishing">Furnishing Status</label>
                <select id="furnishing" name="furnishing">
                  <option value="">Select</option>
                  <option value="unfurnished">Unfurnished</option>
                  <option value="semi-furnished">Semi-Furnished</option>
                  <option value="fully-furnished">Fully Furnished</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group full-width">
                <label for="property-description">Property Description*</label>
                <textarea
                  id="property-description"
                  name="property-description"
                  rows="4"
                  required
                  placeholder="Describe your property in detail, including special features and nearby amenities"
                ></textarea>
                <span class="error-message"
                  >Please provide a property description</span
                >
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2>Location Details</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="address">Complete Address*</label>
                <input
                  type="text"
                  id="address"
                  name="address"
                  required
                  placeholder="Street address"
                />
                <span class="error-message">Please enter the address</span>
              </div>
              <div class="form-group">
                <label for="landmark">Landmark</label>
                <input
                  type="text"
                  id="landmark"
                  name="landmark"
                  placeholder="Nearby landmark for easy navigation"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City*</label>
                <input
                  type="text"
                  id="city"
                  name="city"
                  required
                  placeholder="City"
                />
                <span class="error-message">Please enter the city</span>
              </div>
              <div class="form-group">
                <label for="state">State*</label>
                <input
                  type="text"
                  id="state"
                  name="state"
                  required
                  placeholder="State"
                />
                <span class="error-message">Please enter the state</span>
              </div>
              <div class="form-group">
                <label for="pincode">Pincode*</label>
                <input
                  type="text"
                  id="pincode"
                  name="pincode"
                  required
                  placeholder="Pincode"
                />
                <span class="error-message">Please enter the pincode</span>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full-width">
                <label for="map-link">Google Maps Embed Link</label>
                <input
                  type="url"
                  id="map-link"
                  name="map-link"
                  placeholder="Paste Google Maps embed link (e.g., https://www.google.com/maps/embed?...)"
                />
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2>Rental Details</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="rent-amount">Monthly Rent (₹)*</label>
                <input
                  type="number"
                  id="rent-amount"
                  name="rent-amount"
                  required
                  placeholder="e.g., 15000"
                />
                <span class="error-message">Please enter the monthly rent</span>
              </div>
              <div class="form-group">
                <label for="security-deposit">Security Deposit (₹)*</label>
                <input
                  type="number"
                  id="security-deposit"
                  name="security-deposit"
                  required
                  placeholder="e.g., 30000"
                />
                <span class="error-message"
                  >Please enter the security deposit</span
                >
              </div>
              <div class="form-group">
                <label for="maintenance">Maintenance Charges (₹)</label>
                <input
                  type="number"
                  id="maintenance"
                  name="maintenance"
                  placeholder="e.g., 1500"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="available-from">Available From*</label>
                <input
                  type="date"
                  id="available-from"
                  name="available-from"
                  required
                />
                <span class="error-message"
                  >Please select availability date</span
                >
              </div>
              <div class="form-group">
                <label for="preferred-tenants">Preferred Tenants</label>
                <select id="preferred-tenants" name="preferred-tenants">
                  <option value="any">Any</option>
                  <option value="family">Family</option>
                  <option value="bachelors">Bachelors</option>
                  <option value="company">Company</option>
                </select>
              </div>
              <div class="form-group">
                <label for="lease-duration">Minimum Lease Duration*</label>
                <select id="lease-duration" name="lease-duration" required>
                  <option value="">Select</option>
                  <option value="3">3 months</option>
                  <option value="6">6 months</option>
                  <option value="11">11 months</option>
                  <option value="12">12 months</option>
                  <option value="24">24 months</option>
                </select>
                <span class="error-message">Please select lease duration</span>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2>Amenities & Facilities</h2>
            <div class="amenities-grid">
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="parking"
                  name="amenities"
                  value="parking"
                />
                <label for="parking">Parking</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="lift"
                  name="amenities"
                  value="lift"
                />
                <label for="lift">Lift</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="Balcony"
                  name="amenities"
                  value="Balcony"
                />
                <label for="power-backup">Balcony</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="security"
                  name="amenities"
                  value="security"
                />
                <label for="security">Security</label>
              </div>
              <div class="amenity-checkbox">
                <input type="checkbox" id="gym" name="amenities" value="gym" />
                <label for="gym">Gym</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="swimming-pool"
                  name="amenities"
                  value="swimming-pool"
                />
                <label for="swimming-pool">Swimming Pool</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="children-play-area"
                  name="amenities"
                  value="children-play-area"
                />
                <label for="children-play-area">Children's Play Area</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="club-house"
                  name="amenities"
                  value="club-house"
                />
                <label for="club-house">Club House</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="gated-community"
                  name="amenities"
                  value="gated-community"
                />
                <label for="gated-community">Gated Community</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="wifi"
                  name="amenities"
                  value="wifi"
                />
                <label for="wifi">Wi-Fi</label>
              </div>
              <div class="amenity-checkbox">
                <input type="checkbox" id="ac" name="amenities" value="ac" />
                <label for="ac">Water supply</label>
              </div>
              <div class="amenity-checkbox">
                <input
                  type="checkbox"
                  id="gas-pipeline"
                  name="amenities"
                  value="gas-pipeline"
                />
                <label for="gas-pipeline">Gas Pipeline</label>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2>Property Photos</h2>
            <div class="form-row">
              <div class="form-group full-width">
                <label for="property-photos">Upload Photos (Max 10)*</label>
                <div class="file-upload-container">
                  <input
                    type="file"
                    id="property-photos"
                    name="property-photos"
                    multiple
                    accept="image/*"
                    required
                  />
                  <div class="file-upload-button">
                    <span>Choose Files</span>
                  </div>
                </div>
                <span class="error-message"
                  >Please upload at least one image</span
                >
                <div id="preview-container" class="preview-container"></div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2>Contact Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="owner-name">Owner Name*</label>
                <input
                  type="text"
                  id="owner-name"
                  name="owner-name"
                  required
                  placeholder="Full Name"
                />
                <span class="error-message">Please enter owner name</span>
              </div>
              <div class="form-group">
                <label for="contact-number">Contact Number*</label>
                <input
                  type="tel"
                  id="contact-number"
                  name="contact-number"
                  required
                  placeholder="10-digit mobile number"
                  pattern="[0-9]{10}"
                />
                <span class="error-message"
                  >Please enter a valid 10-digit contact number</span
                >
              </div>
              <div class="form-group">
                <label for="alternative-number">Alternative Number</label>
                <input
                  type="tel"
                  id="alternative-number"
                  name="alternative-number"
                  placeholder="Alternative contact number"
                  pattern="[0-9]{10}"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full-width">
                <label for="contact-email">Email Address*</label>
                <input
                  type="email"
                  id="contact-email"
                  name="contact-email"
                  required
                  placeholder="Email address"
                />
                <span class="error-message"
                  >Please enter a valid email address</span
                >
              </div>
            </div>
            <div class="form-row">
              <div class="form-group full-width">
                <div class="agreement-checkbox">
                  <input
                    type="checkbox"
                    id="terms-agreement"
                    name="terms-agreement"
                    required
                  />
                  <label for="terms-agreement"
                    >I agree to RentEase's
                    <a href="#">Terms & Conditions</a> and
                    <a href="#">Privacy Policy</a>*</label
                  >
                </div>
                <span class="error-message"
                  >Please agree to the terms and conditions</span
                >
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="secondary-button"
              onclick="resetForm()"
            >
              Clear All
            </button>
            <button type="submit" class="primary-button">Submit Listing</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Toggle Navigation Menu Function
      function toggleNav() {
        const navMenu = document.getElementById("nav-menu");
        const overlay = document.getElementById("overlay");

        if (navMenu && overlay) {
          if (navMenu.classList.contains("active")) {
            navMenu.classList.remove("active");
            overlay.classList.remove("active");
          } else {
            navMenu.classList.add("active");
            overlay.classList.add("active");
          }
        }
      }

      // Add event listener to overlay
      const overlay = document.getElementById("overlay");
      if (overlay) {
        overlay.addEventListener("click", function () {
          const navMenu = document.getElementById("nav-menu");
          if (navMenu) {
            navMenu.classList.remove("active");
            this.classList.remove("active");
          }
        });
      }

      // Function to reset the form
      function resetForm() {
        document.getElementById("property-listing-form").reset();
        document.getElementById("preview-container").innerHTML = "";
        selectedFiles = [];

        // Remove all error classes
        document.querySelectorAll(".form-group").forEach((group) => {
          group.classList.remove("has-error");
        });
      }

      // Store selected files globally
      let selectedFiles = [];

      // Function to handle file uploads and create previews
      document
        .getElementById("property-photos")
        .addEventListener("change", function (event) {
          const files = event.target.files;
          const previewContainer = document.getElementById("preview-container");
          const formGroup = this.closest(".form-group");

          // Remove error if files are selected
          if (files.length > 0) {
            formGroup.classList.remove("has-error");
          }

          // Add new files to selectedFiles, ensuring no duplicates
          const newFiles = Array.from(files).filter(
            (file) =>
              !selectedFiles.some(
                (existing) =>
                  existing.name === file.name && existing.size === file.size
              )
          );
          selectedFiles = [...selectedFiles, ...newFiles].slice(0, 10); // Limit to 10

          // Update previews
          previewContainer.innerHTML = ""; // Clear existing previews

          selectedFiles.forEach((file, index) => {
            if (!file.type.match("image.*")) {
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              const previewWrapper = document.createElement("div");
              previewWrapper.className = "preview-item";

              const img = document.createElement("img");
              img.src = e.target.result;
              img.title = file.name;
              img.style.maxWidth = "100px"; // Ensure visibility

              const removeBtn = document.createElement("span");
              removeBtn.className = "remove-preview";
              removeBtn.innerHTML = "×";
              removeBtn.addEventListener("click", function () {
                selectedFiles.splice(index, 1);
                updatePreviews();
              });

              previewWrapper.appendChild(img);
              previewWrapper.appendChild(removeBtn);
              previewContainer.appendChild(previewWrapper);
            };
            reader.readAsDataURL(file);
          });

          if (selectedFiles.length > 10) {
            alert(
              "You can only upload a maximum of 10 images. The first 10 images have been selected."
            );
          }
        });

      function updatePreviews() {
        const previewContainer = document.getElementById("preview-container");
        previewContainer.innerHTML = "";

        selectedFiles.forEach((file, index) => {
          if (!file.type.match("image.*")) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const previewWrapper = document.createElement("div");
            previewWrapper.className = "preview-item";

            const img = document.createElement("img");
            img.src = e.target.result;
            img.title = file.name;
            img.style.maxWidth = "100px";

            const removeBtn = document.createElement("span");
            removeBtn.className = "remove-preview";
            removeBtn.innerHTML = "×";
            removeBtn.addEventListener("click", function () {
              selectedFiles.splice(index, 1);
              updatePreviews();
            });

            previewWrapper.appendChild(img);
            previewWrapper.appendChild(removeBtn);
            previewContainer.appendChild(previewWrapper);
          };
          reader.readAsDataURL(file);
        });
      }

      // Form validation and submission
      document
        .getElementById("property-listing-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          // Clear all previous errors
          document.querySelectorAll(".form-group").forEach((group) => {
            group.classList.remove("has-error");
          });

          console.log("Form submitted");

          let isValid = true;

          // Validate required fields
          const requiredFields = document.querySelectorAll("[required]");
          requiredFields.forEach((field) => {
            const formGroup = field.closest(".form-group");

            if (field.type === "checkbox") {
              if (!field.checked) {
                isValid = false;
                if (formGroup) formGroup.classList.add("has-error");
              }
            } else if (!field.value || field.value.trim() === "") {
              isValid = false;
              if (formGroup) formGroup.classList.add("has-error");
            }
          });

          // Validate images
          const photoFormGroup = document
            .getElementById("property-photos")
            .closest(".form-group");
          if (selectedFiles.length === 0) {
            isValid = false;
            photoFormGroup.classList.add("has-error");
          }

          if (!isValid) {
            alert("Please fill in all required fields marked with *");
            // Scroll to first error
            const firstError = document.querySelector(".form-group.has-error");
            if (firstError) {
              firstError.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            return;
          }

          // Prepare form data
          const formData = new FormData();

          // Append images
          selectedFiles.forEach((file, index) => {
            if (file.type.match("image.*")) {
              formData.append("property-photos", file);
            }
          });

          // Append other form fields
          for (const [key, value] of new FormData(this).entries()) {
            if (key !== "property-photos") {
              formData.append(key, value);
            }
          }

          // Log FormData entries for debugging
          const formDataEntries = [...formData.entries()].map(
            ([key, value]) => ({
              key,
              value: key === "property-photos" ? value.name : value,
            })
          );
          console.log("FormData entries:", formDataEntries);

          // Submit to backend
          console.log("Sending fetch to /api/property/list-property");
          try {
            const response = await fetch("/api/property/list-property", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              alert(
                "Property listing submitted successfully! Our team will review your listing and it will be live soon."
              );
              resetForm();
            } else {
              alert(result.error || "Error listing property");
            }
          } catch (error) {
            console.error("Error:", error);
            alert(`Error submitting form: ${error.message}`);
          }
        });

      // Remove error styling on input
      document.querySelectorAll("input, select, textarea").forEach((field) => {
        field.addEventListener("input", function () {
          const formGroup = this.closest(".form-group");
          if (formGroup && this.value.trim() !== "") {
            formGroup.classList.remove("has-error");
          }
        });

        field.addEventListener("change", function () {
          const formGroup = this.closest(".form-group");
          if (formGroup && (this.value.trim() !== "" || this.checked)) {
            formGroup.classList.remove("has-error");
          }
        });
      });

      // Custom styling for file input
      document
        .querySelector(".file-upload-button")
        .addEventListener("click", function () {
          document.getElementById("property-photos").click();
        });
    </script>
  </body>
</html>
