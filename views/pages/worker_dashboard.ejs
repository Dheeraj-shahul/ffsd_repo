<!-- Add this near the top of your worker_dashboard.ejs file -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('User data received:', <%= JSON.stringify(user) %>);
    console.log('Services data received:', <%= JSON.stringify(services) %>);
  });
</script>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Domestic Worker Dashboard - RentEase</title>
    <link rel="stylesheet" href="css/domestic_worker_dahboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSF7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <%- include('../partials/header') %>
    <button class="menu-toggle" onclick="toggleMenu()">
      <strong>></strong>
    </button>

    <div class="dashboard-container">
      <div class="sidebar">
        <h2>Worker Dashboard</h2>
        <h2><%= user.firstName %> <%= user.lastName %></h2>
        <ul>
          <li onclick="showSection('services')">
            <i class="fa-solid fa-rectangle-list"></i> My Services
          </li>
          <li onclick="showSection('bookings')">
            <i class="fa-solid fa-clipboard-list" id="mybooking_icon"></i> My Bookings
          </li>
          <li onclick="showSection('clients')">
            <i class="fa-solid fa-users"></i> My Clients
          </li>
          <li onclick="showSection('earnings')">
            <i class="fa-solid fa-hand-holding-dollar"></i> Earnings
          </li>
          <li onclick="showSection('reviews')">
            <i class="fa-solid fa-star-half-stroke"></i> Reviews & Ratings
          </li>
          <li onclick="showSection('settings')">
            <i class="fa-solid fa-gears"></i> Settings
          </li>
        </ul>
      </div>

      <div class="main-content">
        <div id="services" class="section active">
          <h3>My Services</h3>
          <div id="prop_container">
            <% if (user.serviceType && services && services.length > 0) { %>
              <% services.forEach(service => { %>
                <div id="gs_container" class="after_scroll_container">
                  <div class="sc_image_cotainer">
                    <img src="<%= service.image || '/images/default_service.jpg' %>" class="sc_image" />
                  </div>
                  <div class="main_sen"><%= service.name %></div>
                  <div class="sc_text">
                    <div class="prop_details">
                      <ul>
                        <li><strong>Rate : </strong>₹<%= service.price %> <%= service.rateUnit %></li>
                        <li><strong>Experience :</strong> <%= service.experience %> years</li>
                        <li><strong>Status :</strong> <%= service.serviceStatus %></li>
                      </ul>
                    </div>
                    <div id="prop_view">
                      <button class="prop_button" onclick="viewServiceDetails('<%= user._id %>')">Service Details</button>
              
                      <button class="prop_button" onclick="toggleServiceAvailability('<%= user._id %>')">Toggle Availability</button>
                      <button class="prop_button" onclick="deleteService()">Delete Service</button>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p>No services available. Update your profile to add a service.</p>
            <% } %>
          </div>
          <button class="add-button" onclick="location.href='/worker_register'">Update Profile</button>
        </div>

      <!-- Bookings Section -->
<div id="bookings" class="section">
  <h3>My Bookings</h3>
  <div class="complaint_container">
    <% bookings.forEach(booking => { %>
      <div class="res_complaint">
        <ul>
          <strong><li><%= booking.serviceName || 'Service' %></li></strong>
          <ul>
            <li><strong>Client: </strong><%= booking.tenantId.firstName %> <%= booking.tenantId.lastName %></li>
            <li><strong>Address: </strong><%= booking.propertyId.address %></li>
            <li><strong>Date: </strong><%= booking.date %></li>
            <li><strong>Time: </strong><%= booking.time %></li>
            <li><strong>Status: </strong><%= booking.status %></li>
          </ul>
        </ul>
        <% if (booking.status === 'Pending') { %>
          <button class="update_sts" onclick="updateBookingStatus('<%= booking._id %>', 'Approved')">Accept Booking</button>
          <button class="update_sts" onclick="updateBookingStatus('<%= booking._id %>', 'Declined')">Decline Booking</button>
        <% } else if (booking.status === 'Approved') { %>
          <button class="update_sts" onclick="updateBookingStatus('<%= booking._id %>', 'Completed')">Mark as Complete</button>
        <% } %>
      </div>
    <% }) %>
  </div>
</div>


      <!-- Clients Section -->
<div id="clients" class="section">
  <h3>My Clients</h3>
  <div class="messages">
    <% clients.forEach(client => { %>
      <div class="tentant_details">
        <ul>
          <li><strong><%= client.firstName %> <%= client.lastName %></strong></li>
          <li><strong>Service: </strong><a href="#"> <%= client.services.join(', ') %></a></li>
          <li><strong>Contact: </strong><%= client.phone %></li>
        </ul>
        <button class="msg_button" onclick="viewMessages('<%= client._id %>')">View Messages</button>
      </div>
    <% }) %>
  </div>
</div>


        <div id="earnings" class="section">
          <h3>My Earnings</h3>
          <p>This Month's Earnings: <strong>₹<%= earnings.monthly || 0 %></strong></p>
          <p>Pending Payments: <strong>₹<%= earnings.pending || 0 %></strong></p>
          <div class="complaint_container">
            <% if (transactions && transactions.length > 0) { %>
              <% transactions.forEach(transaction => { %>
                <div class="res_complaint">
                  <ul>
                    <strong><li><%= transaction.title %></li></strong>
                    <ul>
                      <li><strong>Service:</strong> <%= transaction.serviceName %></li>
                      <li><strong>Client:</strong> <%= transaction.clientName %></li>
                      <li><strong><%= transaction.period ? 'Period' : 'Date' %>:</strong> <%= transaction.period || transaction.date %></li>
                      <li><strong>Amount:</strong> ₹<%= transaction.amount %></li>
                      <li><strong>Status:</strong> <%= transaction.status %></li>
                    </ul>
                  </ul>
                </div>
              <% }) %>
            <% } else { %>
              <p>No transactions available.</p> 
            <% } %>
          </div>
          <button class="pay-button">View All Transactions</button>
        </div>


        <div id="reviews" class="section">
          <h3>Reviews & Ratings</h3>
          <p>Overall Rating: <strong><%= reviews.averageRating || 0 %>/5</strong> (<%= reviews.count || 0 %> reviews)</p>
          <div class="complaint_container">
            <% if (reviews.items && reviews.items.length > 0) { %>
              <% reviews.items.forEach(review => { %>
                <div class="res_complaint">
                  <ul>
                    <strong><li><%= review.user %> - <%= '⭐'.repeat(review.rating) %></li></strong>
                    <ul>
                      <li><strong>Service:</strong> <%= review.serviceName %></li>
                      <li><strong>Date:</strong> <%= review.date %></li>
                      <li><strong>Comment:</strong> <%= review.comment %></li>
                    </ul>
                  </ul>
                </div>
              <% }) %>
            <% } else { %>
              <p>No reviews available.</p>
            <% } %>
          </div>
          <button class="report-button">View All Reviews</button>
        </div>

        <div id="settings" class="section">
          <h3>Account Settings</h3>
          <form id="settingsForm">
            <div class="settings-container">
              <div class="settings-section">
                <h4>Personal Information</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="settingsFirstName">First Name</label>
                    <input
                      type="text"
                      id="settingsFirstName"
                      name="firstName"
                      placeholder="First name"
                      value="<%= user.firstName %>"
                    />
                    <div id="settingsFirstNameError" class="error"></div>
                  </div>
                  <div class="form-group">
                    <label for="settingsLastName">Last Name</label>
                    <input
                      type="text"
                      id="settingsLastName"
                      name="lastName"
                      placeholder="Last name"
                      value="<%= user.lastName %>"
                    />
                    <div id="settingsLastNameError" class="error"></div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="settingsEmail">Email</label>
                  <input
                    type="email"
                    id="settingsEmail"
                    name="email"
                    placeholder="Enter your email"
                    value="<%= user.email %>"
                  />
                  <div id="settingsEmailError" class="error"></div>
                </div>
                <div class="form-group">
                  <label for="settingsPhone">Phone Number</label>
                  <input
                    type="tel"
                    id="settingsPhone"
                    name="phone"
                    placeholder="Enter your phone number"
                    value="<%= user.phone %>"
                  />
                  <div id="settingsPhoneError" class="error"></div>
                </div>
              </div>
              <div class="settings-section">
                <h4>Worker Information</h4>
                <div class="form-group">
                  <label for="settingsLocation">Service Area</label>
                  <input
                    type="text"
                    id="settingsLocation"
                    name="location"
                    placeholder="City, State, Country"
                    value="<%= user.location %>"
                  />
                  <div id="settingsLocationError" class="error"></div>
                </div>
                <div class="form-group">
                  <label for="settingsExperience">Years of Experience</label>
                  <input
                    type="number"
                    id="settingsExperience"
                    name="experience"
                    min="0"
                    placeholder="Years of experience"
                    value="<%= user.experience %>"
                  />
                </div>
                <div class="form-group">
                  <label for="settingsAvailability">Availability</label>
                  <select id="settingsAvailability" name="availability">
                    <option value="full-time" <%= user.availability === 'full-time' ? 'selected' : '' %>>Full Time</option>
                    <option value="part-time" <%= user.availability === 'part-time' ? 'selected' : '' %>>Part Time</option>
                    <option value="weekends" <%= user.availability === 'weekends' ? 'selected' : '' %>>Weekends Only</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Services Offered</label>
                  <div class="checkbox-group">
                    <input
                      type="checkbox"
                      id="cleaning"
                      name="cleaning"
                      <%= user.serviceType === 'cleaning' ? 'checked' : '' %>
                    />
                    <label for="cleaning">Home Cleaning</label>
                  </div>
                  <div class="checkbox-group">
                    <input
                      type="checkbox"
                      id="cooking"
                      name="cooking"
                      <%= user.serviceType === 'cooking' ? 'checked' : '' %>
                    />
                    <label for="cooking">Cooking</label>
                  </div>
                </div>
              </div>
              <div class="settings-section">
                <h4>Change Password</h4>
                <div class="form-group">
                  <label for="settingsCurrentPassword">Current Password</label>
                  <input
                    type="password"
                    id="settingsCurrentPassword"
                    name="currentPassword"
                    placeholder="Current password"
                  />
                  <div id="settingsCurrentPasswordError" class="error"></div>
                </div>
                <div class="form-group">
                  <label for="settingsNewPassword">New Password</label>
                  <input
                    type="password"
                    id="settingsNewPassword"
                    name="newPassword"
                    placeholder="New password"
                  />
                  <div id="settingsNewPasswordError" class="error"></div>
                </div>
                <div class="form-group">
                  <label for="settingsConfirmPassword">Confirm New Password</label>
                  <input
                    type="password"
                    id="settingsConfirmPassword"
                    name="confirmPassword"
                    placeholder="Confirm new password"
                  />
                  <div id="settingsConfirmPasswordError" class="error"></div>
                </div>
              </div>
              <div class="settings-section">
                <h4>Notification Preferences</h4>
                <div class="checkbox-group">
                  <label for="emailNotifications">Email notifications</label>
                  <input
                    type="checkbox"
                    id="emailNotifications"
                    name="emailNotifications"
                    <%= user.emailNotifications ? 'checked' : '' %>
                  />
                  <label for="emailNotifications" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="smsNotifications">SMS notifications</label>
                  <input
                    type="checkbox"
                    id="smsNotifications"
                    name="smsNotifications"
                    <%= user.smsNotifications ? 'checked' : '' %>
                  />
                  <label for="smsNotifications" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="bookingAlerts">New booking alerts</label>
                  <input
                    type="checkbox"
                    id="bookingAlerts"
                    name="bookingAlerts"
                    <%= user.bookingAlerts ? 'checked' : '' %>
                  />
                  <label for="bookingAlerts" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="paymentAlerts">Payment alerts</label>
                  <input
                    type="checkbox"
                    id="paymentAlerts"
                    name="paymentAlerts"
                    <%= user.paymentAlerts ? 'checked' : '' %>
                  />
                  <label for="paymentAlerts" class="button"></label>
                </div>
              </div>
            </div>
            <div class="button-container">
              <button
                type="submit"
                id="saveSettingsBtn"
                class="settings-button primary-button"
              >
                Save Changes
              </button>
              <button
                type="button"
                id="cancelSettingsBtn"
                class="settings-button secondary-button"
              >
                Cancel
              </button>
            </div>
          </form>
          <div id="settingsSuccessMessage" class="success-message">
            Your settings have been updated successfully!
          </div>
        </div>
      </div>
    </div>

    <script>
      function showSection(sectionId) {
        const sections = document.querySelectorAll(".section");
        sections.forEach((section) => {
          section.classList.remove("active");
        });
        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
          activeSection.classList.add("active");
        }
        if (window.innerWidth <= 768) {
          document.querySelector(".sidebar").classList.remove("active");
          document.querySelector(".menu-toggle").innerHTML = "<strong>></strong>";
        }
      }

      function toggleMenu() {
        const sidebar = document.querySelector(".sidebar");
        const menuButton = document.querySelector(".menu-toggle");
        const overlay = document.getElementById("overlay");
        sidebar.classList.toggle("active");
        if (sidebar.classList.contains("active")) {
          menuButton.innerHTML = "<strong><</strong>";
        } else {
          menuButton.innerHTML = "<strong>></strong>";
        }
      }

      function toggleNav() {
        const navMenu = document.getElementById("nav-menu");
        const overlay = document.getElementById("overlay");
        if (navMenu.classList.contains("active")) {
          navMenu.classList.remove("active");
          overlay.classList.remove("active");
        } else {
          navMenu.classList.add("active");
          overlay.classList.add("active");
        }
      }

      document.getElementById("overlay").addEventListener("click", function () {
        document.getElementById("nav-menu").classList.remove("active");
        document.getElementById("overlay").classList.remove("active");
      });

      function viewServiceDetails(workerId) {
        window.location.href = `/service/${workerId}`;
      }
     
      function toggleServiceAvailability(workerId) {
        fetch(`/api/workers/${workerId}/toggle`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(`Service is now ${data.serviceStatus}`);
              location.reload();
            } else {
              alert('Error toggling availability: ' + data.error);
            }
          })
          .catch(error => {
            alert('Error toggling availability: ' + error.message);
          });
      }

      function deleteService() {
        if (confirm("Are you sure you want to delete your service? You can re-register later.")) {
          fetch("/api/workers/delete-service", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("Service deleted successfully! Redirecting to dashboard.");
                window.location.reload();
              } else {
                alert("Error deleting service: " + data.error);
              }
            })
            .catch(error => {
              alert("Error deleting service: " + error.message);
            });
        }
      }

      
      function updateBookingStatus(bookingId, status) {
  fetch(`/api/workers/bookings/${bookingId}/status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ status }),
  })
    .then(response => response.json())
    .then(data => {
      if (data.message === `Booking status updated to ${status}!`) {
        window.location.reload(); // Reload to reflect updated clients and bookings
      } else {
        alert(data.message || 'Error updating status');
      }
    })
    .catch(error => {
      console.error('Error updating booking status:', error);
      alert('Failed to update booking status');
    });
}

    
      function viewMessages(clientId) {
        window.location.href = `/worker/messages/${clientId}`;
      }

      
    </script>
  </body>
</html>