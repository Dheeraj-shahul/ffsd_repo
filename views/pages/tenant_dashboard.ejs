<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tenant Dashboard - RentEase</title>
    <link rel="stylesheet" href="/css/user_dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <!-- Header -->
    <%- include('../partials/header') %>

    <div class="overlay" id="overlay"></div>
    <button class="menu-toggle" onclick="toggleMenu()">
      <strong>></strong>
    </button>
    <div class="dashboard-container">
      <!-- Sidebar Navigation -->
      <div class="sidebar" id="sidebar">
        <h2>Tenant Dashboard</h2>
        <ul>
          <li onclick="showSection('home')">
            <i class="fa-solid fa-house"></i> Home
          </li>
          <li onclick="showSection('rentPayments')">
            <i class="fa-solid fa-hand-holding-dollar"></i> Rent Payments
          </li>
          <li onclick="showSection('maintenance')">
            <i class="fa-solid fa-screwdriver-wrench"></i> Maintenance
          </li>
          <li onclick="showSection('complaints')">
            <i class="fa-solid fa-comments"></i> Complaints
          </li>
          <li onclick="showSection('movers')">
            <i class="fa-solid fa-users"></i> Domestic Workers
          </li>
          <li onclick="showSection('history')">
            <i class="fa-solid fa-clock-rotate-left"></i> Rental History
          </li>
          <li onclick="showSection('savedListings')">
            <i class="fa-solid fa-bookmark"></i> Saved Listings
          </li>
          <li onclick="showSection('ratings')">
            <i class="fa-solid fa-star-half-stroke"></i>Reviews & Ratings
          </li>
          <li onclick="showSection('settings')">
            <i class="fa-solid fa-gears"></i> Settings
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Home Section -->
        <div id="home" class="section active">
          <h3>Welcome, <%= user.firstName %> <%= user.lastName %></h3>
          <% if (currentProperty) { %>
          <div class="property-summary">
            <h4>Currently Renting</h4>
            <div class="property-card" id="home_proprty_card">
              <div class="img_container">
                <img
                  src="<%= currentProperty.images[0] || '/images/default-property.jpg' %>"
                  alt="Property Image"
                />
              </div>
              <div class="property-details">
                <p>
                  <strong>Property:</strong> <%= currentProperty.subtype %> <%=
                  currentProperty.name %>
                </p>
                <p><strong>Address:</strong> <%= currentProperty.address %></p>
                <p>
                  <strong>Owner:</strong> <%= propertyOwner ?
                  propertyOwner.firstName + ' ' + propertyOwner.lastName : 'N/A'
                  %>
                </p>
                <p>
                  <strong>Contact:</strong> <%= propertyOwner ?
                  propertyOwner.email : 'N/A' %>
                </p>
                <p>
                  <strong>Monthly Rent:</strong> ₹<%= currentProperty.price %>
                </p>
                <p>
                  <strong>Due Date:</strong> <%= nextPayment ? new
                  Date(nextPayment.dueDate).toLocaleDateString() : 'N/A' %>
                </p>
                <p>
                  <strong>Lease Period:</strong> <%= rentalHistory &&
                  rentalHistory[0] ? new
                  Date(rentalHistory[0].startDate).toLocaleDateString() + ' - '
                  + (rentalHistory[0].endDate ? new
                  Date(rentalHistory[0].endDate).toLocaleDateString() :
                  'Ongoing') : 'N/A' %>
                </p>
              </div>
            </div>
          </div>
          <div class="quick-stats">
            <div class="stat-box">
              <h4>Next Rent Due</h4>
              <p>₹<%= nextPayment ? nextPayment.amount : 'N/A' %></p>
              <p>
                <%= nextPayment ? 'Due in ' + Math.ceil((new
                Date(nextPayment.dueDate) - new Date()) / (1000 * 60 * 60 * 24))
                + ' days' : 'N/A' %>
              </p>
            </div>
            <div class="stat-box">
              <h4>Active Maintenance</h4>
              <p><%= activeMaintenanceRequests.length %> Pending Requests</p>
            </div>
            <div class="stat-box">
              <h4>Saved Properties</h4>
              <p><%= user.savedListings.length %> Properties</p>
            </div>
          </div>
          <% } else { %>
          <p>No current property rented.</p>
          <% } %>
        </div>

        <!-- Rent Payments Section -->
        <div id="rentPayments" class="section">
          <h3>Rent Payments</h3>
          <% if (nextPayment) { %>
          <div class="current-rent">
            <p>
              Next Rent Due: <strong>₹<%= nextPayment.amount %></strong> on <%=
              new Date(nextPayment.dueDate).toLocaleDateString() %>
            </p>
            <button
              class="pay-buttons"
              onclick="alert('Payment processing not implemented')"
            >
              Pay Now
            </button>
          </div>
          <% } %>
          <h4>Payment History</h4>
          <div id="payment-history-container">
            <table class="payment-history">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Payment Method</th>
                  <th>Status</th>
                  <th>Receipt</th>
                </tr>
              </thead>
              <tbody>
                <% payments.forEach(payment => { %>
                <tr>
                  <td>
                    <%= new Date(payment.paymentDate).toLocaleDateString() %>
                  </td>
                  <td>₹<%= payment.amount %></td>
                  <td><%= payment.paymentMethod %></td>
                  <td class="<%= payment.status.toLowerCase() %>">
                    <%= payment.status %>
                  </td>
                  <td><a href="<%= payment.receiptUrl || '#' %>">View</a></td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Maintenance Request Section -->
        <div id="maintenance" class="section">
          <h3>Maintenance Requests</h3>
          <button class="book-button">Submit New Request</button>
          <h4>Active Requests</h4>
          <div class="maintenance-cards">
            <% activeMaintenanceRequests.forEach(request => { %>
            <div class="maintenance-card">
              <div class="maintenance-header">
                <h5><%= request.issueType %> Issue</h5>
                <span
                  class="status <%= request.status.toLowerCase().replace(' ', '-') %>"
                  ><%= request.status %></span
                >
              </div>
              <p>
                <strong>Date Reported:</strong> <%= new
                Date(request.dateReported).toLocaleDateString() %>
              </p>
              <p><strong>Description:</strong> <%= request.description %></p>
              <p><strong>Location:</strong> <%= request.location %></p>
              <p>
                <strong>Assigned To:</strong> <%= request.assignedTo ||
                'Awaiting assignment' %>
              </p>
              <% if (request.scheduledDate) { %>
              <p>
                <strong>Scheduled For:</strong> <%= new
                Date(request.scheduledDate).toLocaleString() %>
              </p>
              <% } %>
              <button class="small-button">Update</button>
            </div>
            <% }); %>
          </div>
          <h4>Completed Requests</h4>
          <div class="maintenance-cards">
            <% completedMaintenanceRequests.forEach(request => { %>
            <div class="maintenance-card">
              <div class="maintenance-header">
                <h5><%= request.issueType %> Issue</h5>
                <span class="status completed">Completed</span>
              </div>
              <p>
                <strong>Date Reported:</strong> <%= new
                Date(request.dateReported).toLocaleDateString() %>
              </p>
              <p>
                <strong>Date Completed:</strong> <%= new
                Date(request.completedDate).toLocaleDateString() %>
              </p>
              <p><strong>Description:</strong> <%= request.description %></p>
              <p>
                <strong>Serviced By:</strong> <%= request.assignedTo || 'N/A' %>
              </p>
            </div>
            <% }); %>
          </div>
        </div>

        <div id="maintenance-request-popup" class="popup-container">
          <div class="popup-content">
            <span class="close-btn">×</span>
            <h3>Submit Maintenance Request</h3>
            <form id="maintenance-request-form">
              <div class="form-group">
                <label for="issue-type">Issue Type:</label>
                <select id="issue-type" required>
                  <option value="">Select an issue type</option>
                  <option value="Plumbing">Plumbing</option>
                  <option value="Electrical">Electrical</option>
                  <option value="HVAC">HVAC/AC</option>
                  <option value="Appliance">Appliance</option>
                  <option value="Structural">Structural</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea
                  id="description"
                  rows="4"
                  placeholder="Please describe the issue in detail"
                  required
                ></textarea>
              </div>
              <div class="form-group">
                <label for="location">Location:</label>
                <input
                  type="text"
                  id="location"
                  placeholder="e.g., Kitchen, Bathroom, Living Room"
                  required
                />
              </div>
              <div class="form-group">
                <label for="preferred-date">Date</label>
                <input type="date" id="preferred-date" />
              </div>
              <div class="form-group">
                <button type="submit" class="submit-btn">Submit Request</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Complaint Submission Section -->
        <div id="complaints" class="section">
          <h3>Submit a Query / Complaint</h3>
          <form class="query-form" id="complaint-form">
            <select required>
              <option value="" disabled selected>Select Category</option>
              <option value="rent">Rent Related</option>
              <option value="property">Property Issues</option>
              <option value="neighbor">Neighbor Complaints</option>
              <option value="service">Service Quality</option>
              <option value="other">Other</option>
            </select>
            <input
              type="text"
              placeholder="Subject"
              class="query-text-input"
              required
            />
            <textarea
              class="query-text-input"
              rows="4"
              placeholder="Describe your issue..."
              required
            ></textarea>
            <button type="submit">Submit Complaint</button>
          </form>
          <h4>Previous Complaints</h4>
          <div class="complaints-history">
            <% complaints.forEach(complaint => { %>
            <div class="complaint-item">
              <div class="complaint-header">
                <h5><%= complaint.subject %></h5>
                <span
                  class="status <%= complaint.status.toLowerCase().replace(' ', '-') %>"
                  ><%= complaint.status %></span
                >
              </div>
              <p>
                <strong>Date:</strong> <%= new
                Date(complaint.dateSubmitted).toLocaleDateString() %>
              </p>
              <p><strong>Description:</strong> <%= complaint.description %></p>
              <% if (complaint.response) { %>
              <p><strong>Response:</strong> <%= complaint.response %></p>
              <% } %>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Domestic Workers Booking -->
        <div id="movers" class="section">
          <h3>Domestic Worker Services</h3>
          <p>
            Book verified domestic workers nearby to complete your daily chores.
          </p>
          <div class="service-categories">
            <div class="service-category">
              <h4>Cleaning Services</h4>
              <p>Professional house cleaning</p>
              <button
                class="book-button"
                onclick="location.href='/workerDetails'"
              >
                Find Cleaners
              </button>
            </div>
            <div class="service-category">
              <h4>Cooking Services</h4>
              <p>Skilled cooks for daily meals</p>
              <button
                class="book-button"
                onclick="location.href='/workerDetails'"
              >
                Find Cooks
              </button>
            </div>
            <div class="service-category">
              <h4>Laundry Services</h4>
              <p>Washing and ironing services</p>
              <button
                class="book-button"
                onclick="location.href='/workerDetails'"
              >
                Find Help
              </button>
            </div>
          </div>
          <h4>Your Current Service Providers</h4>
          <div class="worker-cards">
            <% workers.forEach(worker => { %>
            <div class="worker-card">
              <img
                src="<%= worker.image || '/resources/default-worker.jpg' %>"
                alt="Worker Photo"
              />
              <div class="worker-details">
                <h5><%= worker.firstName %> <%= worker.lastName %></h5>
                <p><strong>Service:</strong> <%= worker.serviceType %></p>
                <p>
                  <strong>Schedule:</strong> <%= worker.schedule || 'N/A' %>
                </p>
                <p><strong>Monthly Fee:</strong> ₹<%= worker.fee || 'N/A' %></p>
                <div class="rating">
                  <span><%= '⭐'.repeat(Math.round(worker.rating)) %></span> <%=
                  worker.rating?.toFixed(1) || 'N/A' %>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Rental History -->
        <div id="history" class="section">
          <h3>Rental History</h3>
          <div class="history-timeline">
            <% rentalHistory.forEach(history => { %>
            <div class="history-item">
              <div class="timeline-dot"></div>
              <div class="history-content">
                <h4><%= history.property.name %></h4>
                <p>
                  <strong>Period:</strong> <%= new
                  Date(history.startDate).toLocaleDateString() %> - <%=
                  history.endDate ? new
                  Date(history.endDate).toLocaleDateString() : 'Present' %>
                </p>
                <p><strong>Monthly Rent:</strong> ₹<%= history.rent %></p>
                <p><strong>Owner:</strong> <%= history.owner %></p>
                <p><strong>Address:</strong> <%= history.address %></p>
                <p>
                  <strong>Status:</strong>
                  <span class="status <%= history.status.toLowerCase() %>"
                    ><%= history.status %></span
                  >
                </p>
                <% if (history.reasonForMoving) { %>
                <p>
                  <strong>Reason for Moving:</strong> <%=
                  history.reasonForMoving %>
                </p>
                <% } %>
              </div>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Saved Listings -->
        <div id="savedListings" class="section">
          <h3>Saved Listings</h3>
          <p>
            You have saved <%= user.savedListings.length %> properties for
            future reference.
          </p>
          <div class="saved-properties">
            <% user.savedListings.forEach(property => { %>
            <div class="property-card">
              <div class="img_container">
                <img
                  src="<%= property.images[0] || '/images/default-property.jpg' %>"
                  alt="Property Image"
                />
              </div>
              <div class="property-info">
                <h4><%= property.name %></h4>
                <p><strong>Location:</strong> <%= property.location %></p>
                <p><strong>Rent:</strong> ₹<%= property.price %>/month</p>
                <p>
                  <strong>Available From:</strong> <%= property.availableFrom ||
                  'Immediate' %>
                </p>
                <div class="property-features">
                  <span><%= property.subtype %></span>
                  <span><%= property.size %></span>
                  <span><%= property.furnished %></span>
                </div>
                <div class="card-actions">
                  <button
                    class="book-button"
                    onclick="location.href='/property?id=<%= property._id %>'"
                  >
                    View Details
                  </button>
                  <button
                    class="remove-button"
                    onclick="removeSavedProperty('<%= property._id %>')"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Reviews & Ratings Section -->
        <div id="ratings" class="section">
          <h3>Reviews & Ratings</h3>
          <h4>Your Property Reviews</h4>
          <% if (currentProperty) { %>
          <div class="review-form">
            <h5>Review Your Current Property</h5>
            <div class="star-rating">
              <span>Rate your experience: </span>
              <div
                class="stars"
                id="star-rating"
                data-property-id="<%= currentProperty._id %>"
              >
                <span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span
                ><span>⭐</span>
              </div>
            </div>
            <textarea
              rows="4"
              placeholder="Share your experience living here..."
              id="review-text"
            ></textarea>
            <button type="submit" id="review-submission">Submit Review</button>
          </div>
          <% } %>
          <h4>Past Reviews</h4>
          <div class="past-reviews">
            <% ratings.forEach(rating => { %>
            <div class="review-card">
              <div class="review-header">
                <h5><%= rating.propertyId.name %></h5>
                <div class="rating">
                  <%= '⭐'.repeat(rating.rating) %> <%= rating.rating.toFixed(1)
                  %>
                </div>
              </div>
              <p class="review-date">
                Reviewed on: <%= new Date(rating.date).toLocaleDateString() %>
              </p>
              <p class="review-text"><%= rating.review %></p>
            </div>
            <% }); %>
          </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="section">
          <h3>Account Settings</h3>
          <div class="settings-container">
            <div id="profile-section">
              <h4>Personal Information</h4>
              <form class="profile-form" id="profile-form">
                <div class="form-group">
                  <label for="fullname">Full Name</label>
                  <input
                    type="text"
                    id="fullname"
                    value="<%= user.firstName %> <%= user.lastName %>"
                  />
                </div>
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" value="<%= user.email %>" />
                </div>
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" value="<%= user.phone %>" />
                </div>
                <div class="form-group">
                  <label for="address">Current Address</label>
                  <textarea id="address"><%= user.location %></textarea>
                </div>
                <button type="submit" class="settings-submission-class">
                  Update Profile
                </button>
              </form>
            </div>
            <div id="security-section">
              <h4>Security Settings</h4>
              <form class="password-form" id="password-form">
                <div class="form-group">
                  <label for="current-password">Current Password</label>
                  <input type="password" id="current-password" />
                </div>
                <div class="form-group">
                  <label for="new-password">New Password</label>
                  <input type="password" id="new-password" />
                </div>
                <div class="form-group">
                  <label for="confirm-password">Confirm New Password</label>
                  <input type="password" id="confirm-password" />
                </div>
                <button type="submit" class="settings-submission-class">
                  Change Password
                </button>
              </form>
            </div>
            <div id="preferences-section">
              <h4>Notification Preferences</h4>
              <form class="notification-form" id="notification-form">
                <div class="checkbox-group">
                  <label for="email-notifications">Email Notifications</label>
                  <input type="checkbox" id="email-notifications" <%=
                  user.emailNotifications ? 'checked' : '' %> />
                  <label for="email-notifications" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="sms-notifications">SMS Notifications</label>
                  <input type="checkbox" id="sms-notifications" <%=
                  user.smsNotifications ? 'checked' : '' %> />
                  <label for="sms-notifications" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="rent-reminders">Rent Due Reminders</label>
                  <input type="checkbox" id="rent-reminders" <%=
                  user.rentReminders ? 'checked' : '' %> />
                  <label for="rent-reminders" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="maintenance-updates">Maintenance Updates</label>
                  <input type="checkbox" id="maintenance-updates" <%=
                  user.maintenanceUpdates ? 'checked' : '' %> />
                  <label for="maintenance-updates" class="button"></label>
                </div>
                <div class="checkbox-group">
                  <label for="new-listings">New Property Listings</label>
                  <input type="checkbox" id="new-listings" <%= user.newListings
                  ? 'checked' : '' %> />
                  <label for="new-listings" class="button"></label>
                </div>
                <button type="submit" class="settings-submission-class">
                  Save Preferences
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showSection(sectionId) {
        const sections = document.querySelectorAll(".section");
        sections.forEach((section) => section.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");
        const sidebar = document.querySelector(".sidebar");
        const menuButton = document.querySelector(".menu-toggle");
        if (window.innerWidth <= 768) {
          sidebar.classList.remove("active");
          menuButton.innerHTML = "<strong>></strong>";
        }
      }

      function toggleMenu() {
        const sidebar = document.querySelector(".sidebar");
        const menuButton = document.querySelector(".menu-toggle");
        sidebar.classList.toggle("active");
        menuButton.innerHTML = sidebar.classList.contains("active")
          ? "<strong><</strong>"
          : "<strong>></strong>";
      }

      function toggleNav() {
        const navMenu = document.getElementById("nav-menu");
        const overlay = document.getElementById("overlay");
        navMenu.classList.toggle("active");
        overlay.classList.toggle("active");
      }

      document.getElementById("overlay").addEventListener("click", function () {
        const navMenu = document.getElementById("nav-menu");
        navMenu.classList.remove("active");
        this.classList.remove("active");
      });

      document.addEventListener("DOMContentLoaded", function () {
        const popup = document.getElementById("maintenance-request-popup");
        const bookButton = document.querySelector(".book-button");
        const closeBtn = document.querySelector(".close-btn");
        const maintenanceForm = document.getElementById(
          "maintenance-request-form"
        );
        const complaintForm = document.getElementById("complaint-form");
        const reviewForm = document.getElementById("review-submission");
        const profileForm = document.getElementById("profile-form");
        const passwordForm = document.getElementById("password-form");
        const notificationForm = document.getElementById("notification-form");

        bookButton.addEventListener("click", function () {
          popup.style.display = "flex";
        });

        closeBtn.addEventListener("click", function () {
          popup.style.display = "none";
        });

        window.addEventListener("click", function (event) {
          if (event.target === popup) {
            popup.style.display = "none";
          }
        });

        maintenanceForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const issueType = document.getElementById("issue-type").value;
          const description = document.getElementById("description").value;
          const location = document.getElementById("location").value;
          const preferredDate = document.getElementById("preferred-date").value;

          try {
            const response = await fetch("/tenant/maintenance/submit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                issueType,
                description,
                location,
                preferredDate,
              }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              addNewRequest(result.request);
              maintenanceForm.reset();
              popup.style.display = "none";
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error submitting request");
          }
        });

        complaintForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const category = complaintForm.querySelector("select").value;
          const subject = complaintForm.querySelector("input").value;
          const description = complaintForm.querySelector("textarea").value;

          try {
            const response = await fetch("/tenant/complaint/submit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ category, subject, description }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              addNewComplaint(result.complaint);
              complaintForm.reset();
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error submitting complaint");
          }
        });

        reviewForm.addEventListener("click", async function () {
          const propertyId =
            document.getElementById("star-rating").dataset.propertyId;
          const rating = document.querySelectorAll(
            "#star-rating span.active"
          ).length;
          const review = document.getElementById("review-text").value;

          try {
            const response = await fetch("/tenant/review/submit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ propertyId, rating, review }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              addNewReview(result.rating);
              document.getElementById("review-text").value = "";
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error submitting review");
          }
        });

        profileForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const [firstName, lastName] = document
            .getElementById("fullname")
            .value.split(" ");
          const email = document.getElementById("email").value;
          const phone = document.getElementById("phone").value;
          const location = document.getElementById("address").value;

          try {
            const response = await fetch("/tenant/profile/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                firstName,
                lastName,
                email,
                phone,
                location,
              }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error updating profile");
          }
        });

        passwordForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          if (newPassword !== confirmPassword) {
            alert("New passwords do not match");
            return;
          }

          try {
            const response = await fetch("/tenant/profile/change-password", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ currentPassword, newPassword }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              passwordForm.reset();
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error changing password");
          }
        });

        notificationForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          const emailNotifications = document.getElementById(
            "email-notifications"
          ).checked;
          const smsNotifications =
            document.getElementById("sms-notifications").checked;
          const rentReminders =
            document.getElementById("rent-reminders").checked;
          const maintenanceUpdates = document.getElementById(
            "maintenance-updates"
          ).checked;
          const newListings = document.getElementById("new-listings").checked;

          try {
            const response = await fetch("/tenant/profile/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                emailNotifications,
                smsNotifications,
                rentReminders,
                maintenanceUpdates,
                newListings,
              }),
            });
            const result = await response.json();
            if (result.success) {
              alert("Notification preferences updated successfully");
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error updating preferences");
          }
        });

        async function removeSavedProperty(propertyId) {
          try {
            const response = await fetch("/tenant/property/toggle-save", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ propertyId, action: "remove" }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              document
                .querySelector(
                  .property-card[data-property-id="${propertyId}"]
                )
                ?.remove();
            } else {
              alert(result.error);
            }
          } catch (error) {
            alert("Error removing property");
          }
        }

        function addNewRequest(request) {
          const activeRequestsContainer =
            document.querySelector(".maintenance-cards");
          const newCard = document.createElement("div");
          newCard.className = "maintenance-card";
          newCard.innerHTML = `
            <div class="maintenance-header">
              <h5>${request.issueType} Issue</h5>
              <span class="status pending">Pending</span>
            </div>
            <p><strong>Date Reported:</strong> ${new Date(
              request.dateReported
            ).toLocaleDateString()}</p>
            <p><strong>Description:</strong> ${request.description}</p>
            <p><strong>Location:</strong> ${request.location}</p>
            ${
              request.scheduledDate
                ? `<p><strong>Preferred Date:</strong> ${new Date(
                    request.scheduledDate
                  ).toLocaleDateString()}</p>`
                : ""
            }
            <p><strong>Assigned To:</strong> Awaiting assignment</p>
            <button class="small-button">Update</button>
          `;
          activeRequestsContainer.insertBefore(
            newCard,
            activeRequestsContainer.firstChild
          );
        }

        function addNewComplaint(complaint) {
          const complaintsContainer = document.querySelector(
            ".complaints-history"
          );
          const newItem = document.createElement("div");
          newItem.className = "complaint-item";
          newItem.innerHTML = `
            <div class="complaint-header">
              <h5>${complaint.subject}</h5>
              <span class="status open">Open</span>
            </div>
            <p><strong>Date:</strong> ${new Date(
              complaint.dateSubmitted
            ).toLocaleDateString()}</p>
            <p><strong>Description:</strong> ${complaint.description}</p>
          `;
          complaintsContainer.insertBefore(
            newItem,
            complaintsContainer.firstChild
          );
        }

        function addNewReview(rating) {
          const reviewsContainer = document.querySelector(".past-reviews");
          const newCard = document.createElement("div");
          newCard.className = "review-card";
          newCard.innerHTML = `
            <div class="review-header">
              <h5>${rating.propertyId.name}</h5>
              <div class="rating">${"⭐".repeat(
                rating.rating
              )} ${rating.rating.toFixed(1)}</div>
            </div>
            <p class="review-date">Reviewed on: ${new Date(
              rating.date
            ).toLocaleDateString()}</p>
            <p class="review-text">${rating.review}</p>
          `;
          reviewsContainer.insertBefore(newCard, reviewsContainer.firstChild);
        }

        // Star rating interactivity
        const stars = document.querySelectorAll("#star-rating span");
        stars.forEach((star, index) => {
          star.addEventListener("click", () => {
            stars.forEach((s, i) => {
              s.classList.toggle("active", i <= index);
            });
          });
        });
      });
    </script>
  </body>
</html>