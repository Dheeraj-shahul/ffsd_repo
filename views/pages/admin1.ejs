<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <!-- Add Poppins font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Base styles with Poppins */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', Arial, sans-serif;
      color: #333;
    }
    
    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    h2 {
      color: #ffc107;
      font-weight: 500;
      margin-bottom: 15px;
    }
    
    h3 {
      font-weight: 500;
      font-size: 16px;
    }
    
    /* Navigation */
    .navbar {
      position: sticky;
      top: 0;
      background:#333;
      padding: 28px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .navbar a {
      color: #ffc107;
      text-decoration: none;
      margin: 0 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Poppins', Arial, sans-serif;
    }
    
    .navbar a:hover {
      color: #ffc107;
      transform: translateY(-2px);
    }
    
    /* Section styles */
    section {
      margin: 25px 0;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    
    .stat-card {
      padding: 18px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card p {
      font-size: 18px;
      font-weight: 600;
      margin-top: 8px;
      color: #ff6f00;
    }
    
    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-family: 'Poppins', Arial, sans-serif;
      table-layout: fixed;
    }
    
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    th {
      background: #333;
      color: white;
      font-weight: 500;
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    /* Action buttons */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .action-buttons a, 
    .action-buttons button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 12px;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .action-buttons a {
      background: #ff6f00;
      color: white;
    }
    
    .action-buttons a:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    .action-buttons button {
      background: #6c757d;
      color: white;
    }
    
    .action-buttons button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .action-buttons .danger {
      background: #dc3545;
    }
    
    .action-buttons .danger:hover {
      background: #c82333;
    }
    
    .action-buttons .success {
      background: #28a745;
    }
    
    .action-buttons .success:hover {
      background: #218838;
    }
    
    /* Charts section */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
    }
    
    .chart-container {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* No data message */
    .no-data {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-size: 14px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-content h3 {
      margin-bottom: 15px;
    }
    
    .modal-content p {
      margin: 10px 0;
      line-height: 1.5;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
      color: #333;
    }

    /* ✅ CHART FIXES */
.chart-container canvas {
  max-height: 250px !important;
  height: 250px !important;
}

.charts {
  max-height: 1200px !important;
  overflow: visible !important;
}

.chart-container {
  position: relative !important;
  height: 300px !important;
}
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- Navigation Header -->
  <nav class="navbar">
    <a href="#overview">Overview</a>
    <a href="#property-management">Properties</a>
    <a href="#user-management">Users</a>
    <a href="#service-bookings">Bookings</a>
    <a href="#payments">Payments</a>
    <a href="#worker-payments">Worker Payments</a>
    <a href="#notifications">Notifications</a>
    <a href="#maintenance-requests">Maintenance Requests</a>
    <a href="#messages">Messages</a>
    <a href="#reports">Reports</a>
  </nav>

  <!-- Dashboard Overview -->
  <section id="overview" class="overview">
    <h2>Dashboard Overview</h2>
    <div class="stats-grid">
      <% [
        { title: 'Total Properties', value: stats.totalProperties },
        { title: 'Total Renters', value: stats.totalRenters },
        { title: 'Total Owners', value: stats.totalOwners },
        { title: 'Total Workers', value: stats.totalWorkers },
        { title: 'Active Rentals', value: stats.activeRentals },
        { title: 'Active Users', value: stats.activeUsers },
        { title: 'Total Revenue', value: `₹${stats.totalRevenue?.toFixed(2)}` },
        { title: 'Daily Revenue', value: `₹${stats.revenueDaily?.toFixed(2)}` },
        { title: 'Weekly Revenue', value: `₹${stats.revenueWeekly?.toFixed(2)}` },
        { title: 'Monthly Revenue', value: `₹${stats.revenueMonthly?.toFixed(2)}` },
        { title: 'Active Properties', value: stats.propertiesActive },
        { title: 'Pending Properties', value: stats.propertiesPending },
        { title: 'Available Properties', value: stats.propertiesAvailable },
        { title: 'Available Workers', value: stats.workersAvailable },
      ].forEach(stat => { %>
        <div class="stat-card">
          <h3><%= stat.title %></h3>
          <p><%= stat.value %></p>
        </div>
      <% }) %>
    </div>
  </section>

  <!-- Property Management -->
  <section id="property-management" class="property-management">
    <h2>Property Management</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Name</th>
          <th style="width: 10%;">Owner</th>
          <th style="width: 10%;">Location</th>
          <th style="width: 8%;">Type</th>
          <th style="width: 8%;">Subtype</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Rented</th>
          <th style="width: 10%;">Tenant</th>
          <th style="width: 10%;">Workers</th>
          <th style="width: 8%;">Price</th>
          <th style="width: 8%;">Created</th>
          <th style="width: 8%;">Updated</th>
          <th style="width: 8%;">Verified</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% properties.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td><%= p.name %></td>
            <td><a href="/admin/user/<%= p.ownerIdStr %>/owner"><%= p.ownerName %></a></td>
            <td><%= p.location %></td>
            <td><%= p.type %></td>
            <td><%= p.subtype %></td>
            <td><%= p.status %></td>
            <td><%= p.isRented ? 'Yes' : 'No' %></td>
            <td>
              <% if (p.tenantIdStr) { %>
                <a href="/admin/user/<%= p.tenantIdStr %>/tenant"><%= p.tenantName %></a>
              <% } else { %>
                Available
              <% } %>
            </td>
            <td><%= p.activeWorkers?.length ? p.activeWorkers.map(w => w.name).join(', ') : 'None' %></td>
            <td>₹<%= p.price ? Number(p.price).toFixed(2) : 'N/A' %></td>
            <td><%= p.createdAt ? new Date(p.createdAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.isVerified ? 'Yes' : 'No' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/property/<%= p.id %>">View</a>
                <a href="/property?id=<%= p.id %>">Site</a>
                <button class="success" onclick="toggleVerify('<%= p._id %>', <%= p.isVerified ? 'false' : 'true' %>)">
                  <%= p.isVerified ? 'Unverify' : 'Verify' %>
                </button>
                <button class="danger" onclick="deleteProperty('<%= p._id %>')">Delete</button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- User Management -->
  <section id="user-management" class="user-management">
    <h2>User Management</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Name</th>
          <th style="width: 8%;">Role</th>
          <th style="width: 10%;">Email</th>
          <th style="width: 10%;">Phone</th>
          <th style="width: 10%;">Address</th>
          <th style="width: 8%;">Registered</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Bookings</th>
          <th style="width: 8%;">Service</th>
          <th style="width: 8%;">Exp</th>
          <th style="width: 8%;">Properties</th>
          <th style="width: 8%;">Owner/House</th>
          <th style="width: 8%;">Account</th>
          <th style="width: 8%;">UPI</th>
          <th style="width: 18%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.id %></td>
            <td><%= u.firstName %> <%= u.lastName %></td>
            <td><%= u.userType %></td>
            <td><%= u.email %></td>
            <td><%= u.phone %></td>
            <td><%= u.address || 'N/A' %></td>
            <td><%= u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= u.status %></td>
            <td><%= u.tenantBookings || u.clientCount || 'N/A' %></td>
            <td><%= u.serviceType || 'N/A' %></td>
            <td><%= u.experience ? u.experience + ' yrs' : 'N/A' %></td>
            <td><%= u.numProperties || u.propertyCount || 'N/A' %></td>
            <td><%= u.ownerName || 'N/A' %></td>
            <td><%= u.accountNo || 'N/A' %></td>
            <td><%= u.upiid || 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/user/<%= u.id %>/<%= u.userType %>">View</a>
                <button class="success" onclick="suspendUser('<%= u.id %>', '<%= u.userType %>', '<%= u.status === 'Active' ? 'Suspended' : 'Active' %>')">
                  <%= u.status === 'Active' ? 'Suspend' : 'Activate' %>
                </button>
                <button class="danger" onclick="deleteUser('<%= u.id %>', '<%= u.userType %>')">Delete</button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Service Bookings -->
  <section id="service-bookings" class="service-bookings">
    <h2>Bookings</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 12%;">Tenant</th>
          <th style="width: 12%;">Property</th>
          <th style="width: 12%;">Worker</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Booked</th>
          <th style="width: 8%;">Start</th>
          <th style="width: 8%;">End</th>
          <th style="width: 8%;">Amount</th>
          <th style="width: 16%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% bookings.forEach(b => { %>
          <tr>
            <td><%= b.id %></td>
            <td><a href="/admin/user/<%= b.userId %>/tenant"><%= b.userName %></a></td>
            <td><a href="/admin/property/<%= b.propertyIdStr %>"><%= b.propertyName %></a></td>
            <td>
              <% if (b.workerId) { %>
                <a href="/admin/user/<%= b.workerId %>/worker"><%= b.workerName %></a>
              <% } else { %>
                None Assigned
              <% } %>
            </td>
            <td><%= b.status %></td>
            <td><%= b.bookingDate ? new Date(b.bookingDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= b.startDate ? new Date(b.startDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= b.endDate ? new Date(b.endDate).toLocaleDateString() : 'N/A' %></td>
            <td>₹<%= b.price ? b.price.toFixed(2) : 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/booking/<%= b.id %>">View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Payments and Transactions -->
  <section id="payments" class="payments">
    <h2>Payments and Transactions</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">User</th>
          <th style="width: 10%;">Amount</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Method</th>
          <th style="width: 10%;">Transaction</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% payments.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td><a href="/admin/user/<%= p.user %>/tenant"><%= p.userName || 'N/A' %></a></td>
            <td>₹<%= p.amount?.toFixed(2) %></td>
            <td><%= p.status %></td>
            <td><%= p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.paymentMethod || 'N/A' %></td>
            <td><%= p.transactionId || 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/payment/<%= p.id %>">View</a>
                <% if (p.status === 'Completed') { %>
                  <button class="danger" onclick="refundPayment('<%= p.id %>')">Refund</button>
                <% } else if (p.status === 'Failed') { %>
                  <button class="success" onclick="retryPayment('<%= p.id %>')">Retry</button>
                <% } %>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Worker Payments -->
  <section id="worker-payments" class="worker-payments">
    <h2>Worker Payments</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Paid By</th>
          <th style="width: 10%;">Received By</th>
          <th style="width: 10%;">Amount</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Method</th>
          <th style="width: 10%;">Transaction</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% workerPayments.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td>
              <a href="/admin/user/<%= p.paidById %>/tenant">
                <%= p.paidByName ? p.paidByName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A' %>
              </a>
            </td>
            <td>
              <a href="/admin/user/<%= p.receivedById %>/worker">
                <%= p.receivedByName ? p.receivedByName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A' %>
              </a>
            </td>
            <td>₹<%= p.amount ? p.amount.toFixed(2) : 'N/A' %></td>
            <td><%= p.status || 'N/A' %></td>
            <td><%= p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.paymentMethod ? p.paymentMethod.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A' %></td>
            <td><%= p.transactionId ? p.transactionId.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/worker-payment/<%= p.id %>">View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Notifications -->
  <section id="notifications" class="notifications">
    <h2>Notifications</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Type</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 30%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% notifications.filter(n => n.status !== 'Completed').forEach(n => { %>
          <tr>
            <td><%= n.id %></td>
            <td><%= n.type %></td>
            <td><%= n.createdDate ? new Date(n.createdDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= n.status %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/notification/<%= n.id %>">View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Maintenance Requests -->
  <section id="maintenance-requests" class="maintenance-requests">
    <h2>Maintenance Requests</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Issue</th>
          <th style="width: 10%;">Property</th>
          <th style="width: 10%;">Tenant</th>
          <th style="width: 10%;">Owner</th>
          <th style="width: 10%;">Location</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 12%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (maintenanceRequests && Array.isArray(maintenanceRequests)) { %>
          <% maintenanceRequests.forEach(m => { %>
            <tr>
              <td><%= m.id %></td>
              <td><%= m.issueType %></td>
              <td><a href="/admin/property/<%= m.propertyIdStr %>"><%= m.propertyName %></a></td>
              <td><a href="/admin/user/<%= m.tenantIdStr %>/tenant"><%= m.tenantName %></a></td>
              <td><%= m.ownerName %></td>
              <td><%= m.location %></td>
              <td><%= m.dateReported ? new Date(m.dateReported).toLocaleDateString() : 'N/A' %></td>
              <td><%= m.status %></td>
              <td>
                <div class="action-buttons">
                  <a href="/admin/maintenance/<%= m.id %>">View</a>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="9" class="no-data">No maintenance requests available</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </section>

  <!-- Messages (Contact Us Submissions) -->
  <section id="messages" class="messages">
    <h2>Contact Us Messages</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 10%;">ID</th>
          <th style="width: 20%;">Name</th>
          <th style="width: 20%;">Email</th>
          <th style="width: 15%;">Phone</th>
          <th style="width: 15%;">Subject</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody id="messagesTableBody">
        <% if (contactSubmissions && Array.isArray(contactSubmissions)) { %>
          <% contactSubmissions.forEach(s => { %>
            <tr>
              <td><%= s.id %></td>
              <td><%= s.name %></td>
              <td><%= s.email %></td>
              <td><%= s.phone || 'N/A' %></td>
              <td><%= s.subject %></td>
              <td>
                <div class="action-buttons">
                  <a href="/admin/message/<%= s.id %>">View</a>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="6" class="no-data">No messages available</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </section>

  <!-- Reports and Analytics -->
<section id="reports" class="reports">
  <h2>📊 Reports & Analytics (2025)</h2>
  <div class="charts" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; max-height: 800px; overflow-y: auto;">
    
    <!-- BAR CHARTS (Top Row) -->
    <div class="chart-container">
      <h3>🏠 New Properties</h3>
      <canvas id="propertiesChart" height="250"></canvas>
    </div>

    <div class="chart-container">
      <h3>👥 New Tenants</h3>
      <canvas id="tenantsChart" height="250"></canvas>
    </div>

    <div class="chart-container">
      <h3>🔧 New Workers</h3>
      <canvas id="workersChart" height="250"></canvas>
    </div>

    <div class="chart-container">
      <h3>👨‍💼 New Owners</h3>
      <canvas id="ownersChart" height="250"></canvas>
    </div>

    <!-- ✅ FIXED: ADD THIS LINE -->
    <div class="chart-container">
      <h3>🛠️ New Services</h3>
      <canvas id="servicesChart" height="250"></canvas>
    </div>

    <!-- PIE CHARTS (Bottom Row) -->
    <div class="chart-container">
      <h3>🥧 User Types</h3>
      <canvas id="userTypeChart" height="250"></canvas>
    </div>

    <div class="chart-container">
      <h3>🥧 Property Status</h3>
      <canvas id="propertyStatusChart" height="250"></canvas>
    </div>

    <!-- REVENUE CHART (Full Width) -->
    <div class="chart-container" style="grid-column: 1 / -1;">
      <h3>💰 Total Revenue (₹)</h3>
      <canvas id="revenueChart" height="300"></canvas>
    </div>

  </div>
</section>

<!-- FIXED JavaScript -->
<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartsInitialized = false; // ✅ FIX: Prevent infinite loop

document.addEventListener('DOMContentLoaded', function() {
  if (chartsInitialized) return; // ✅ STOP RE-RUNNING
  chartsInitialized = true;
  
  const analytics = <%- JSON.stringify(analyticsData) %>;
  
  console.log('🧮 Analytics Data:', analytics); // ✅ DEBUG
  
  if (analytics && analytics.quarters && analytics.quarters.length > 0) {
    // ✅ SINGLE CALL - NO LOOPS!
    initAllCharts(analytics);
  } else {
    console.error('❌ No analytics data!');
  }
});

function initAllCharts(analytics) {
  // BAR CHARTS (5x)
  initBarChart('propertiesChart', analytics.quarters, analytics.newProperties, 'New Properties', '#28a745');
  initBarChart('tenantsChart', analytics.quarters, analytics.newTenants, 'New Tenants', '#007bff');
  initBarChart('workersChart', analytics.quarters, analytics.newWorkers, 'New Workers', '#ffc107');
  initBarChart('ownersChart', analytics.quarters, analytics.newOwners, 'New Owners', '#6f42c1');
  initBarChart('servicesChart', analytics.quarters, analytics.newServices, 'New Services', '#fd7e14');
  
  // REVENUE CHART
  initRevenueChart('revenueChart', analytics.quarters, analytics.totalRevenue);
  
  // PIE CHARTS (2x)
  initPieChart('userTypeChart', 
    ['Tenants', 'Owners', 'Workers'], 
    [analytics.userTypeDistribution.tenants, 
     analytics.userTypeDistribution.owners, 
     analytics.userTypeDistribution.workers]
  );
  
  initPieChart('propertyStatusChart', 
    ['Rented', 'Available', 'Pending'], 
    [analytics.propertyStatusDistribution.rented, 
     analytics.propertyStatusDistribution.available, 
     analytics.propertyStatusDistribution.pending]
  );
  
  console.log('✅ ALL 8 CHARTS LOADED!');
}

function initBarChart(canvasId, labels, data, title, color) {
  try {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`❌ Canvas ${canvasId} not found!`);
      return;
    }
    
    const ctx = canvas.getContext('2d');
    // ✅ DESTROY OLD CHART IF EXISTS
    if (window[`chart_${canvasId}`]) {
      window[`chart_${canvasId}`].destroy();
    }
    
    window[`chart_${canvasId}`] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels || [],
        datasets: [{
          label: title,
          data: data || [],
          backgroundColor: color + '30',
          borderColor: color,
          borderWidth: 2,
          borderRadius: 6,
          maxBarThickness: 40
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // ✅ STOP MOVING!
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `${context.dataset.label}: ${context.parsed.y}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { font: { size: 11 } }
          },
          x: {
            ticks: { font: { size: 10 }, maxRotation: 45 }
          }
        }
      }
    });
    console.log(`✅ ${canvasId} LOADED`);
  } catch (err) {
    console.error(`❌ ${canvasId} ERROR:`, err);
  }
}

function initRevenueChart(canvasId, labels, data) {
  try {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (window[`chart_${canvasId}`]) {
      window[`chart_${canvasId}`].destroy();
    }
    
    window[`chart_${canvasId}`] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels || [],
        datasets: [{
          label: 'Revenue',
          data: data || [],
          backgroundColor: '#dc354530',
          borderColor: '#dc3545',
          borderWidth: 3,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // ✅ STOP MOVING!
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => `₹${context.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              font: { size: 11 },
              callback: (value) => `₹${value.toLocaleString()}` 
            }
          },
          x: { ticks: { font: { size: 10 }, maxRotation: 45 } }
        }
      }
    });
    console.log(`✅ ${canvasId} LOADED`);
  } catch (err) {
    console.error(`❌ ${canvasId} ERROR:`, err);
  }
}

function initPieChart(canvasId, labels, data) {
  try {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (window[`chart_${canvasId}`]) {
      window[`chart_${canvasId}`].destroy();
    }
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
    
    window[`chart_${canvasId}`] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels || [],
        datasets: [{
          data: data || [],
          backgroundColor: colors.slice(0, labels.length),
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false, // ✅ STOP MOVING!
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { font: { size: 11 } }
          }
        }
      }
    });
    console.log(`✅ ${canvasId} LOADED`);
  } catch (err) {
    console.error(`❌ ${canvasId} ERROR:`, err);
  }
}
</script>
</body>
<script src="js/admin.js"></script>
</html>