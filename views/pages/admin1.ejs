<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <!-- Add Poppins font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Base styles with Poppins */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', Arial, sans-serif;
      color: #333;
    }
    
    h1 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    h2 {
      color: #ffc107;
      font-weight: 500;
      margin-bottom: 15px;
    }
    
    h3 {
      font-weight: 500;
      font-size: 16px;
    }
    
    /* Navigation */
    .navbar {
      position: sticky;
      top: 0;
      background:#333;
      padding: 28px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .navbar a {
      color: #ffc107;
      text-decoration: none;
      margin: 0 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Poppins', Arial, sans-serif;
    }
    
    .navbar a:hover {
      color: #ffc107;
      transform: translateY(-2px);
    }
    
    /* Section styles */
    section {
      margin: 25px 0;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
    }
    
    .stat-card {
      padding: 18px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card p {
      font-size: 18px;
      font-weight: 600;
      margin-top: 8px;
      color: #ff6f00;
    }
    
    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-family: 'Poppins', Arial, sans-serif;
      table-layout: fixed;
    }
    
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    th {
      background: #333;
      color: white;
      font-weight: 500;
    }
    
    tr:hover {
      background: #f5f5f5;
    }
    
    /* Action buttons */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .action-buttons a, 
    .action-buttons button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 12px;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .action-buttons a {
      background: #ff6f00;
      color: white;
    }
    
    .action-buttons a:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    .action-buttons button {
      background: #6c757d;
      color: white;
    }
    
    .action-buttons button:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .action-buttons .danger {
      background: #dc3545;
    }
    
    .action-buttons .danger:hover {
      background: #c82333;
    }
    
    .action-buttons .success {
      background: #28a745;
    }
    
    .action-buttons .success:hover {
      background: #218838;
    }
    
    /* Charts section */
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
    }
    
    .chart-container {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* No data message */
    .no-data {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-size: 14px;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-content h3 {
      margin-bottom: 15px;
    }
    
    .modal-content p {
      margin: 10px 0;
      line-height: 1.5;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- Navigation Header -->
  <nav class="navbar">
    <a href="#overview">Overview</a>
    <a href="#property-management">Properties</a>
    <a href="#user-management">Users</a>
    <a href="#service-bookings">Bookings</a>
    <a href="#payments">Payments</a>
    <a href="#notifications">Notifications</a>
    <a href="#maintenance-requests">Maintenance Requests</a>
    <a href="#messages">Messages</a>
    <a href="#reports">Reports</a>
  </nav>

  <!-- Dashboard Overview -->
  <section id="overview" class="overview">
    <h2>Dashboard Overview</h2>
    <div class="stats-grid">
      <% [
        { title: 'Total Properties', value: stats.totalProperties },
        { title: 'Total Renters', value: stats.totalRenters },
        { title: 'Total Owners', value: stats.totalOwners },
        { title: 'Total Workers', value: stats.totalWorkers },
        { title: 'Active Rentals', value: stats.activeRentals },
        { title: 'Pending Bookings', value: stats.pendingBookings },
        { title: 'Cancelled Bookings', value: stats.cancelledBookings },
        { title: 'Active Users', value: stats.activeUsers },
        { title: 'Total Revenue', value: `₹${stats.totalRevenue?.toFixed(2)}` },
        { title: 'Daily Revenue', value: `₹${stats.revenueDaily?.toFixed(2)}` },
        { title: 'Weekly Revenue', value: `₹${stats.revenueWeekly?.toFixed(2)}` },
        { title: 'Monthly Revenue', value: `₹${stats.revenueMonthly?.toFixed(2)}` },
        { title: 'Active Properties', value: stats.propertiesActive },
        { title: 'Pending Properties', value: stats.propertiesPending },
        { title: 'Available Workers', value: stats.workersAvailable },
      ].forEach(stat => { %>
        <div class="stat-card">
          <h3><%= stat.title %></h3>
          <p><%= stat.value %></p>
        </div>
      <% }) %>
    </div>
  </section>

  <!-- Property Management -->
  <section id="property-management" class="property-management">
    <h2>Property Management</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Name</th>
          <th style="width: 10%;">Owner</th>
          <th style="width: 10%;">Location</th>
          <th style="width: 8%;">Type</th>
          <th style="width: 8%;">Subtype</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Rented</th>
          <th style="width: 10%;">Tenant</th>
          <th style="width: 10%;">Workers</th>
          <th style="width: 8%;">Price</th>
          <th style="width: 8%;">Created</th>
          <th style="width: 8%;">Updated</th>
          <th style="width: 8%;">Verified</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% properties.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td><%= p.name %></td>
            <td><a href="/admin/user/<%= p.ownerId %>/owner"><%= p.owner || 'N/A' %></a></td>
            <td><%= p.location %></td>
            <td><%= p.type %></td>
            <td><%= p.subtype %></td>
            <td><%= p.status %></td>
            <td><%= p.isRented ? 'Yes' : 'No' %></td>
            <td>
              <% if (p.tenantId) { %>
                <a href="/admin/user/<%= p.tenantId %>/tenant"><%= p.tenant || 'N/A' %></a>
              <% } else { %>
                N/A
              <% } %>
            </td>
            <td><%= p.activeWorkers?.length ? p.activeWorkers.map(w => w.name).join(', ') : 'None' %></td>
            <td>₹<%= p.price ? Number(p.price).toFixed(2) : 'N/A' %></td>
            <td><%= p.createdAt ? new Date(p.createdAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.isVerified ? 'Yes' : 'No' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/property/<%= p.id %>">View</a>
                <a href="/property?id=<%= p.id %>" >Site</a>
                <button class="success" onclick="toggleVerify('<%= p._id %>', <%= p.isVerified ? 'false' : 'true' %>)">
                  <%= p.isVerified ? 'Unverify' : 'Verify' %>
                </button>
                <button class="danger" onclick="deleteProperty('<%= p._id %>')">Delete</button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- User Management -->
  <section id="user-management" class="user-management">
    <h2>User Management</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Name</th>
          <th style="width: 8%;">Role</th>
          <th style="width: 10%;">Email</th>
          <th style="width: 10%;">Phone</th>
          <th style="width: 10%;">Address</th>
          <th style="width: 8%;">Registered</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Service Bookings</th>
          <th style="width: 8%;">Domestic Service</th>
          <th style="width: 8%;">Experience</th>
          <th style="width: 8%;">Properties</th>
          <th style="width: 8%;">Account</th>
          <th style="width: 8%;">UPI</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.id %></td>
            <td><%= u.firstName %> <%= u.lastName %></td>
            <td><%= u.userType %></td>
            <td><%= u.email %></td>
            <td><%= u.phone %></td>
            <td><%= u.address || 'N/A' %></td>
            <td><%= u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A' %></td>
            <td><%= u.status %></td>
            <td><%= u.tenantBookings || 'N/A' %></td>
            <td><%= u.serviceType || 'N/A' %></td>
            <td><%= u.experience ? u.experience + ' yrs' : 'N/A' %></td>
            <td><%= u.numProperties || 'N/A' %></td>
            <td><%= u.accountNo || 'N/A' %></td>
            <td><%= u.upiid || 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/user/<%= u.id %>/<%= u.userType %>">View</a>
                <button class="success" onclick="suspendUser('<%= u.id %>', '<%= u.userType %>', '<%= u.status === 'Active' ? 'Suspended' : 'Active' %>')">
                  <%= u.status === 'Active' ? 'Suspend' : 'Activate' %>
                </button>
                <button class="danger" onclick="deleteUser('<%= u.id %>', '<%= u.userType %>')">Delete</button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Service Bookings -->
  <section id="service-bookings" class="service-bookings">
    <h2>Service Bookings</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">User</th>
          <th style="width: 10%;">Property</th>
          <th style="width: 10%;">Worker</th>
          <th style="width: 8%;">Status</th>
          <th style="width: 8%;">Booked</th>
          <th style="width: 8%;">Start</th>
          <th style="width: 8%;">End</th>
          <th style="width: 8%;">Amount</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% bookings.forEach(b => { %>
          <tr>
            <td><%= b.id %></td>
            <td><a href="/admin/user/<%= b.user %>/tenant"><%= b.userName || 'N/A' %></a></td>
            <td><a href="/admin/property/<%= b.property %>"><%= b.propertyName || 'N/A' %></a></td>
            <td>
              <% if (b.assignedWorker) { %>
                <a href="/admin/user/<%= b.assignedWorker %>/worker"><%= b.workerName || 'N/A' %></a>
              <% } else { %>
                None
              <% } %>
            </td>
            <td><%= b.status %></td>
            <td><%= b.bookingDate ? new Date(b.bookingDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= b.startDate ? new Date(b.startDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= b.endDate ? new Date(b.endDate).toLocaleDateString() : 'N/A' %></td>
            <td>₹<%= b.amount ? b.amount.toFixed(2) : 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/booking/<%= b.id %>">View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Payments and Transactions -->
  <section id="payments" class="payments">
    <h2>Payments and Transactions</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">User</th>
          <th style="width: 10%;">Amount</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Method</th>
          <th style="width: 10%;">Transaction</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% payments.forEach(p => { %>
          <tr>
            <td><%= p.id %></td>
            <td><a href="/admin/user/<%= p.user %>/tenant"><%= p.userName || 'N/A' %></a></td>
            <td>₹<%= p.amount?.toFixed(2) %></td>
            <td><%= p.status %></td>
            <td><%= p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= p.paymentMethod || 'N/A' %></td>
            <td><%= p.transactionId || 'N/A' %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/payment/<%= p.id %>">View</a>
                <% if (p.status === 'Completed') { %>
                  <button class="danger" onclick="refundPayment('<%= p.id %>')">Refund</button>
                <% } else if (p.status === 'Failed') { %>
                  <button class="success" onclick="retryPayment('<%= p.id %>')">Retry</button>
                <% } %>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Notifications -->
  <section id="notifications" class="notifications">
    <h2>Notifications</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Type</th>
          <th style="width: 10%;">Date</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 30%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% notifications.filter(n => n.status !== 'Completed').forEach(n => { %>
          <tr>
            <td><%= n.id %></td>
            <td><%= n.type %></td>
            <td><%= n.createdDate ? new Date(n.createdDate).toLocaleDateString() : 'N/A' %></td>
            <td><%= n.status %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/notification/<%= n.id %>">View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- Maintenance Requests -->
  <section id="maintenance-requests" class="maintenance-requests">
    <h2>Maintenance Requests</h2>
    <table>
      <thead>
        <tr>
          <th style="width: 8%;">ID</th>
          <th style="width: 10%;">Issue Type</th>
          <th style="width: 10%;">Property</th>
          <th style="width: 10%;">Tenant</th>
          <th style="width: 10%;">Location</th>
          <th style="width: 10%;">Date Reported</th>
          <th style="width: 10%;">Status</th>
          <th style="width: 20%;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (maintenanceRequests && Array.isArray(maintenanceRequests)) { %>
          <% maintenanceRequests.forEach(m => { %>
            <tr>
              <td><%= m._id %></td>
              <td><%= m.issueType %></td>
              <td><a href="/admin/property/<%= m.propertyId %>"><%= m.propertyName || 'N/A' %></a></td>
              <td>
                <% if (m.tenantId) { %>
                  <a href="/admin/user/<%= m.tenantId %>/tenant"><%= m.tenantName || 'N/A' %></a>
                <% } else { %>
                  None
                <% } %>
              </td>
              <td><%= m.location %></td>
              <td><%= m.dateReported ? new Date(m.dateReported).toLocaleDateString() : 'N/A' %></td>
              <td><%= m.status %></td>
              <td>
                <div class="action-buttons">
                  <a href="/admin/maintenance/<%= m._id %>">View</a>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="10" class="no-data">No maintenance requests available</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </section>

  <!-- Previous sections unchanged -->

<!-- Messages (Contact Us Submissions) -->
<section id="messages" class="messages">
  <h2>Contact Us Messages</h2>
  <table>
    <thead>
      <tr>
        <th style="width: 10%;">ID</th>
        <th style="width: 20%;">Name</th>
        <th style="width: 20%;">Email</th>
        <th style="width: 15%;">Phone</th>
        <th style="width: 15%;">Subject</th>
        <th style="width: 20%;">Actions</th>
      </tr>
    </thead>
    <tbody id="messagesTableBody">
      <% if (contactSubmissions && Array.isArray(contactSubmissions)) { %>
        <% contactSubmissions.forEach(s => { %>
          <tr>
            <td><%= s.id %></td>
            <td><%= s.name %></td>
            <td><%= s.email %></td>
            <td><%= s.phone || 'N/A' %></td>
            <td><%= s.subject %></td>
            <td>
              <div class="action-buttons">
                <a href="/admin/message/<%= s.id %>" >View</a>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="6" class="no-data">No messages available</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</section>

<!-- Reports and Analytics section unchanged -->

  <!-- Reports and Analytics -->
  <section id="reports" class="reports">
    <h2>Reports and Analytics</h2>
    <div class="charts">
      <% const charts = [
        { 
          id: 'bookingStatusChart', 
          title: 'Booking Status', 
          type: 'pie', 
          labels: ['Active', 'Pending', 'Cancelled'],
          data: [
            stats.bookingStatusDistribution?.active || 0,
            stats.bookingStatusDistribution?.pending || 0,
            stats.bookingStatusDistribution?.cancelled || 0
          ],
          color: ['#007bff', '#ffc107', '#dc3545']
        }
      ]; %>
      
      <% charts.forEach(chart => { %>
        <div class="chart-container">
          <h3><%= chart.title %></h3>
          <canvas id="<%= chart.id %>" height="300"></canvas>
        </div>
      <% }); %>
    </div>
  </section>

  <!-- Chart.js Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize all charts
      <% charts.forEach(chart => { %>
        initChart(
          '<%= chart.id %>', 
          '<%= chart.type %>', 
          <%= JSON.stringify(chart.labels) %>, 
          <%= JSON.stringify(chart.data) %>, 
          '<%= chart.title %>',
          <%= JSON.stringify(chart.color) %>,
          '<%= chart.yLabel || "" %>',
          '<%= chart.xLabel || "" %>'
        );
      <% }); %>

      // Fetch contact submissions
      fetch('/api/contact-submissions')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.getElementById('messagesTableBody');
          tableBody.innerHTML = '';
          if (data.length > 0) {
            data.forEach(submission => {
              const row = `
                <tr>
                  <td>${submission.id}</td>
                  <td>${submission.name}</td>
                  <td>${submission.email}</td>
                  <td>${submission.phone || 'N/A'}</td>
                  <td>${submission.subject}</td>
                  <td>
                    <div class="action-buttons">
                      <button class="success" onclick="viewMessage('${submission.id}')">View</button>
                    </div>
                  </td>
                </tr>
              `;
              tableBody.innerHTML += row;
            });
          } else {
            tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No messages available</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error fetching contact submissions:', error);
          document.getElementById('messagesTableBody').innerHTML = 
            '<tr><td colspan="6" class="no-data">Error loading messages</td></tr>';
        });
    });

    function initChart(canvasId, type, labels, data, title, colors, yLabel, xLabel) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      
      const backgroundColors = Array.isArray(colors) ? 
        colors : 
        Array(data.length).fill(colors);
      
      const chartData = {
        labels: labels,
        datasets: [{
          label: title,
          data: data,
          backgroundColor: backgroundColors,
          borderColor: type === 'line' ? backgroundColors : undefined,
          borderWidth: type === 'line' ? 3 : 1,
          fill: type === 'line',
          tension: type === 'line' ? 0.4 : 0
        }]
      };
      
      const config = {
        type: type,
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: type === 'pie' || type === 'doughnut' ? 'right' : 'top',
            },
            title: {
              display: true,
              text: title,
              font: {
                size: 16
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.raw;
                  return label;
                }
              }
            }
          },
          scales: type !== 'pie' && type !== 'doughnut' ? {
            y: {
              beginAtZero: true,
              title: {
                display: !!yLabel,
                text: yLabel
              }
            },
            x: {
              title: {
                display: !!xLabel,
                text: xLabel
              }
            }
          } : undefined
        }
      };
      
      new Chart(ctx, config);
    }

    function viewMessage(id) {
      fetch(`/api/contact-submission/${id}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('modalId').textContent = data.id;
          document.getElementById('modalName').textContent = data.name;
          document.getElementById('modalEmail').textContent = data.email;
          document.getElementById('modalPhone').textContent = data.phone || 'N/A';
          document.getElementById('modalSubject').textContent = data.subject;
          document.getElementById('modalMessage').textContent = data.message;
          document.getElementById('modalSubmittedAt').textContent = data.submittedAt;
          document.getElementById('messageModal').style.display = 'flex';
        })
        .catch(error => {
          console.error('Error fetching message:', error);
          alert('Error loading message details');
        });
    }

    function closeModal() {
      document.getElementById('messageModal').style.display = 'none';
    }
  </script>
</body>
<script src="js/admin.js"></script>
</html>